<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>黑马程序员论坛详情页</title>
    <link rel="stylesheet" type="text/css" href="../css/common.css"/>
    <link rel="stylesheet" type="text/css" href="../css/common-new.css"/>
    <link rel="stylesheet" type="text/css" href="../css/index.css"/>
    <link rel="stylesheet" type="text/css" href="../css/search.css"/>
    <link rel="stylesheet" type="text/css" href="../css/detail.css"/>
    <link rel="stylesheet" type="text/css" href="../css/getArticle.css"/>
    <script type="text/javascript" src="../js/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="../js/hm-bbs.js"></script>
    <script src="/js/getParameter.js"></script>
    <!--点赞 评论 举报位置控制-->
    <style>
        #scomment {
            right: 60px;
        }

        #upvote_css, #l {
            right: 110px;
        }
    </style>

    <script>
        var articleId = getParameter("articleId");
        var flag = 0; // 用于记录点赞状态 0:未点赞 1:已点赞
        var islogin = false; // 用于记录登录状态;

        //加载用户信息
        $(function () {
            //加载用户信息
            $.post("/user/findUserById.do", {}, function (data) {
                if (data.userName != undefined && data.roleStr != undefined) {
                    $("#userName_top").text(data.userName);
                    $("#image").attr("src", data.picUrl);
                    // $("#comment_form").css("visibility", "visible");
                    // $("#showComment").css("visibility", "visible");
                }
            });
        });

        //帖子内容相关
        $(function () {
            //给评论框添加 articleId
            $("#articleId_comment").val(articleId);
            //给回复评论框添加 articleId
            $("#reply_articleId").val(articleId);
            //给举报框添加 articleId
            $("#articleId_report").val(articleId);

            //获取贴子点赞总数
            $.post("/upvote/countUpvoteById.do", {"articleId": articleId}, function (data) {
                $("#countUpvote").html("<i></i>" + data);
            });

            //获取贴子评论总数
            $.post("/comment/countCommentById.do", {"articleId": articleId}, function (data) {
                $("#countComment").html("<i></i>" + data);
            });

            //帖子内容及评论展示
            $.post("/article/findByArticleId.do", {"articleId": articleId}, function (data) {
                var titleStr = "<h2 class=\"l\">" + data.title + "</h2>\n" +
                    "                    <div class=\"hm-detail-fun l\">\n" +
                    "\t\t\t\t\t     <span class=\"icon-like\">\n" +
                    "\t\t\t\t\t         <a href=\"#\"><i></i>" + data.upvoteCount + "</a>\n" +
                    "\t\t\t\t\t     </span>\n" +
                    "                        <span class=\"icon-talk\">\n" +
                    "\t\t\t\t\t\t     <i></i>" + data.replyCount + "\n" +
                    "\t\t\t\t\t\t</span>\n" +
                    "                    </div>";
                $("#title_div").html(titleStr);
                $("#h2_title").html(data.title)

                //原来帖楼
                var articleStr = "<li class=\"floor clearfix\">" +
                    "           <div class=\"floorer-info l\">\n" +
                    "                        <div class=\"floorer-photo\"><img src=\"../images/default.png\"/></div>\n" +
                    "                        <div class=\"floorer-name\">" + data.senderName + "</div>\n" +
                    "                    </div>\n" +
                    "                    <div class=\"floor-con l\">\n" +
                    "                        <div class=\"floor-info clearfix\">\n" +
                    "                            <div class=\"floor-time l\">发帖时间：" + data.sendTimeStr + "</div>\n" +
                    "                            <div class=\"r\">" + data.browseCount + "次查看</div>\n" +
                    "                        </div>\n" +
                    "                        <div class=\"floor-art-ans\">\n" +
                    "                            <div class=\"floor-art\">\n" +
                    "                                <p>" + data.content + "</p>\n" +
                    "                            </div>\n" +
                    "                            <div class=\"floor-ans\"></div>\n" +
                    "                        </div>\n" +
                    "                        <div id='add_upvote'>\n" +
                    "                        </div>\n" +
                    "                        <span class=\"icon-comment\" id='scomment'><a href=\"#comment\"> <i></i> 评论</a></span>\n" +
                    "                        <span class=\"icon-comment\"><a href=\"#comment\" onclick=\"showReport()\"> <i></i> 举报</a></span>\n" +
                    "                    </div>" +
                    "</li>";

                //评论
                if (data.comments != null) {
                    $.each(data.comments, function (index, comment) {
                        if (comment.commentStatus != 1) {
                            articleStr += "<li class=\"floor clearfix\">\n" +
                                "                    <div class=\"floorer-info l\">\n" +
                                "                        <div class=\"floorer-photo\"><img src=\"../images/default.png\"/></div>\n" +
                                "                        <div class=\"floorer-name\">" + comment.commentUserName + "</div>\n" +
                                "                    </div>\n" +
                                "                    <div class=\"floor-con l\">\n" +
                                "                        <div class=\"floor-info clearfix\">\n" +
                                "                            <div class=\"floor-time l\">回贴时间：" + comment.commentTimeStr + "</div>\n" +
                                "                            <div class=\"r\">" + (index + 1) + "楼</div>\n" +
                                "                        </div>\n" +
                                "                        <div class=\"floor-art-ans\">\n" +
                                "                            <div class=\"floor-art\">\n" +
                                "                                <p>" + comment.commentContent + "</p>\n" +
                                "                            </div>\n" +
                                "                            <div class=\"floor-ans\">\n" +
                                "                                ";
                            //回复
                            if (comment.replies != null) {
                                $.each(comment.replies, function (index, reply) {
                                    articleStr += "<ul>\n" +
                                        "                                    <!-- 回复部分,楼中楼 -->\n" +
                                        "                                    <li class=\"clearfix\">\n" +
                                        "                                        <div class=\"floor-ans-pho l\"><img src=\"../images/default.png\"/></div>\n" +
                                        "                                        <div class=\"floor-ans-con l\">\n" +
                                        "                                            <span class=\"name\">" + reply.replyUserName + "</span>：" + reply.replyContent + "\n" +
                                        "                                            <span class=\"ans-time\">" + reply.replyTimeStr + "</span>\n" +
                                        "                                        </div>\n" +
                                        "                                    </li>\n" +
                                        "                                </ul>";
                                })
                            }
                            articleStr += "</div>\n" +
                                "                            <span class=\"icon-feedback\">\n" +
                                "                                <a href=\"javascript:;\" onclick=\"showDialog(" + (index + 1) + "," + comment.commentId + ")\"> <i></i> 回复</a>\n" +
                                "                            </span>\n" +
                                "                        </div>\n" +
                                "                    </div>\n" +
                                "                </li>";
                        }
                    })

                }

                $("#article_ul").html(articleStr);

                //贴子内容加载完成后查询当前用户是否点赞
                $.post("/upvote/isUpvote.do", {"articleId": articleId}, function (data) {
                    flag = data;
                    if (flag == 1) {//已经点赞
                        $("#add_upvote").prepend(
                            "<span class=\"icon-feedback\" id='upvote_css'><a href=\"javascript:;\" onclick=\"isUpvote()\"> <i></i> 已赞</a></span>")
                    } else {
                        $("#add_upvote").prepend(
                            "<span class=\"icon-feedback\" id='upvote_css'><a href=\"javascript:;\" onclick=\"isUpvote()\"> <i></i> 点赞</a></span>")
                    }
                });
            });
        });

        //修改点赞状态
        function isUpvote() {
            if (flag == 1) {
                $("#add_upvote").empty();
                $("#add_upvote").prepend(
                    "<span class=\"icon-feedback\" id='l'><a href=\"javascript:;\" onclick=\"isUpvote()\"> <i></i> 点赞</a></span>")
                flag = 0;
            } else if (flag == 0) {
                $("#add_upvote").empty();
                $("#add_upvote").prepend(
                    "<span class=\"icon-feedback\" id='upvote_css'><a href=\"javascript:;\" onclick=\"isUpvote()\"> <i></i> 已赞</a></span>")
                flag = 1;
            }
            //修改数据库
            $.post("/upvote/addUpvote.do", {"upvoteArticleId": articleId}, function (data) {
                //获取贴子点赞总数
                $.post("/upvote/countUpvoteById.do", {"articleId": articleId}, function (data) {
                    $("#countUpvote").html("<i></i>" + data);
                });
            });
        }

    </script>

</head>
<body>
<!-- 头部 -->
<div class="hm-top-nav">
    <div class="hm-inner clearfix">
        <div class="hm-inner-l l">
        </div>
        <div class="hm-inner-r r">
            <div class="box">
                欢迎<a href="user_info.html" style="margin-right:0px;padding:0px 5px;color:blue;" id="userName_top"></a>回来！
                <a href="#">【注销】</a>
                <div id="dialogBg"></div>
                <div id="dialog" class="animated">
                    <img class="dialogIco" width="50" height="40" src="" id="image"/>
                    <div class="dialogTop" style="height:25px;">
                        <a href="javascript:;" class="closeDialogBtn">关闭</a>
                    </div>
                    <form action="" method="post">
                        <ul class="editInfos">
                            <li>用户名：<input type="text" id="userName" name="userName" class="ipt"/></li>
                            <li>密&nbsp;&nbsp;&nbsp;码：<input type="password" id="userPass" name="userPass" class="ipt"/>
                            </li>
                            <li><input type="submit" value="登录" class="submitBtn"/></li>
                        </ul>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="hm-header"></div>
<div class="hm-body hm-body-bgc">
    <div class="hm-inner">

        <!--帖子标题，点赞数，回复数，搜索-->
        <div class="hm-bbs-info">
            <div class="hm-bbs-icon l" style="width:130px;">
                <span><img src="../images/bbs-icon.png" height="80"/></span>
            </div>
            <div class="hm-bbs-info-in l" style="margin-left:30px;">
                <div class="t clearfix">
                    <h2 class="l">求官方出艾琳英雄活动</h2>
                    <div class="hm-detail-fun l">
					     <span class="icon-like">
					         <a href="#" id="countUpvote"><i></i></a>
					     </span>
                        <span class="icon-talk" id="countComment">
						     <i></i>
						</span>
                    </div>
                </div>
            </div>
            <div class="search-box l">
                <form action="javascript:;">
                    <input type="text" class="txt l" placeholder="请输入关键字">
                    <input type="button" value="搜索" class="btn l"/>
                </form>
            </div>
        </div>


        <!--导航，回首页，帖子标题，排序-->
        <div class="detail-page-box clearfix">
            <a href="index.html">
                <i class="hm-ico-home"></i>首页
            </a>
            <span>></span>
            <a href="   ">求官方出艾琳英雄活动</a>
            <a class="new-to-old r" href="" style="font-size:12px;float: right;">
                <i></i>从新到旧查看
            </a>
        </div>


        <div class="detail-box">
            <ul id="article_ul" class="detail-floors">
                <!--帖子详情 包括 评论和回复-->
            </ul>
        </div>
        <!--发表评论-->
        <div class="detail-to-comment" id="comment_form" >
            <div class="tit"><a name="comment">发表评论</a></div>
            <!-- 未登录时候显示 <div class="con">您没有登录论坛，请登录后再进行回复</div>-->

            <!-- 登录后显示评论输入框-->
            <form method="post" action="/comment/addComment.do">
                <input id="articleId_comment" type="hidden" name="articleId" value="">
                <div class="con con-loged">
                    <div class="con-t">
                        <textarea id="content" name="commentContent" placeholder="请在此输入您要回复的信息"></textarea>
                    </div>
                    <div class="con-b">
                        <input id="submit_comment" type="submit" class="btn" value="提交"/>
                        <span class="num">不能超过5000字</span>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- 底部 -->
<div class="hm-footer" style="padding-top:10px;">
    <div class="hm-inner">
        <div class="hm-footer-cpr">
            <p>Copyright@2006-2017 ITCAST. All Rights Reserved</p>
            <p>传智播客 版权所有</p>
        </div>
    </div>
</div>


<!-- 回复弹出框 -->
<form action="/reply/addReplyByCommentId.do" method="post">
    <input type="hidden" name="commentId" id="commentId" value="">
    <input type="hidden" name="articleId" value="" id="reply_articleId"/>
    <div class="pop-box ft-box" id="commentBox">
        <div class="mask"></div>
        <div class="win">
            <div class="win_hd">
                <h4 class="l">回复<span id="floorSpan"></span>楼</h4>
                <span class="close r">&times;</span>
            </div>
            <div class="win_bd">
                <div class="win_bd_b">
                    <textarea id="replyContent" name="replyContent" placeholder="回复内容限于40字以内"></textarea>
                </div>
            </div>
            <div class="win_ft">
                <div class="win_ft_in">
                    <input type="submit" class="btn" value="回复"/>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- 举报弹出框 -->
<form id="form" action="/report/addReport.do" method="post">
    <div class="pop-box ft-box " id="report">
        <div class="mask"></div>
        <div class="win">
            <div class="win_hd">
                <h4 class="l">举报本贴</h4><span class="close r">&times;</span>
            </div>
            <div class="win_bd">
                <div class="win_bd_t"></div>
                <div class="win_bd_b">
                    <textarea id="reportContent" name="reportContent" placeholder="正文"></textarea>
                </div>
                <!--这里是一个隐藏域 为的是提交的贴子的id -->
                <input id="articleId_report" type="hidden" name="articleId"/>
            </div>
            <div class="win_ft">
                <div class="win_ft_in">
                    <input type="submit" class="btn" value="举报"/>
                </div>
            </div>
        </div>
    </div>
</form>


<div class="fixedBar" id="j_fixedBar">
    <div id="showComment">
        <a href="#comment" class="newTopic"><span></span>回复</a>
    </div>
    <a href="#" class="goTop"><i></i><span>返回<br/>顶部</span></a>
</div>


</body>

<script type="text/javascript">
    //弹出回复框
    function showDialog(num, commentId) {
        $("#commentBox").css('display', 'block');
        $("#floorSpan").html(num);
        $("#commentId").val(commentId);
    }

    //弹出举报框
    function showReport(articleId) {
        $('#report').css('display', 'block');
    }

</script>
</html>